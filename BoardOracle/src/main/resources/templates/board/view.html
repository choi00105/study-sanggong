<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ìš© ë³´ê¸°</title>
<link rel="stylesheet" href="/css/board.css">
<script>

	var myLikeCheck; 
   	var myDislikeCheck; 
   	var username;
   	
	window.onload = () =>{
	   	console.log('[[${session.username}]]');
		// ì—ëŸ¬ëŠ” ì•„ë‹Œë° parseIntë¡œ ë¬¶ìœ¼ë©´ ê²½ê³ ì°½ë„ ì•ˆëœ¸
		likeCnt = parseInt('[[${view.likecnt}]]'); 
	   	dislikeCnt =  parseInt('[[${view.dislikecnt}]]'); 
	   	myLikeCheck = '[[${myLikeCheck}]]'; 
	   	myDislikeCheck = '[[${myDislikeCheck}]]'; 
	   	username = '[[${session.username}]]';
	   	like.innerHTML = likeCnt;
	   	dislike.innerHTML = dislikeCnt;
	   	
	   	if(myLikeCheck == "Y") document.querySelector('.likeClick').style.backgroundColor = '#00B9FF';
	   		else if(myDislikeCheck == "Y") document.querySelector('.dislikeClick').style.backgroundColor = '#00B9FF';
	   	
	   	if(myLikeCheck == "Y") myChoice.innerHTML = username + 'ë‹˜ì˜ ì„ íƒì€ ì¢‹ì•„ìš”ì…ë‹ˆë‹¤.';
	   		else if(myDislikeCheck == "Y") myChoice.innerHTML = username + 'ë‹˜ì˜ ì„ íƒì€ ì‹«ì–´ìš”ì…ë‹ˆë‹¤.';
	   		else if(myLikeCheck == "N" && myDislikeCheck == "N") myChoice.innerHTML = username + 'ë‹˜ì€ ì•„ì§ ì„ íƒì„ ì•ˆ í–ˆë„¤ìš”';
	   	
	}
   	
	// ì¢‹ì•„ìš”, ì‹«ì–´ìš” ì œì´ì¿¼ë¦¬ ì²˜ë¦¬ í•¨ìˆ˜ ì‹œì‘
	const likeView = () => { 
	    
	    if(myLikeCheck == "Y" && myDislikeCheck =="N") {
	        alert("ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤."); 
	        const checkCnt = 1;  //likeCnt --; --> 6ê°œì˜ ì¡°ê±´ ì¤‘ 1ë²ˆ ì¡°ê±´
	        myLikeCheck = "N";
	        sendDataToServer(myLikeCheck,myDislikeCheck,checkCnt); 
	        document.querySelector('.likeClick').style.backgroundColor = '#d2d2d2';
	    }else if(myLikeCheck == "N" && myDislikeCheck =="Y") {
	        alert("ì‹«ì–´ìš”ê°€ ì·¨ì†Œë˜ê³  ì¢‹ì•„ìš”ê°€ ë“±ë¡ë©ë‹ˆë‹¤.");
	        const checkCnt = 2; // likeCnt ++ , dislikeCnt --
	        myLikeCheck = "Y";
	        myDislikeCheck = "N";
	        sendDataToServer(myLikeCheck,myDislikeCheck,checkCnt);  
	        document.querySelector('.likeClick').style.backgroundColor = '#00B9FF';
	        document.querySelector('.dislikeClick').style.backgroundColor = '#d2d2d2';
	    } else if(myLikeCheck == "N" && myDislikeCheck =="N") {
	        alert("ì¢‹ì•„ìš”ë¥¼ ì„ íƒ í–ˆìŠµë‹ˆë‹¤.")
	    	const checkCnt = 3; //likeCnt ++
	        myLikeCheck = "Y";
	        sendDataToServer(myLikeCheck,myDislikeCheck,checkCnt);
	        document.querySelector('.likeClick').style.backgroundColor = '#00B9FF';
	    }
	    if(myLikeCheck == "Y") myChoice.innerHTML = username + "ë‹˜ì˜ ì„ íƒì€ ì¢‹ì•„ìš”ì…ë‹ˆë‹¤.";
	    	else if(myDislikeCheck == "Y") myChoice.innerHTML = username + "ë‹˜ì˜ ì„ íƒì€ ì‹«ì–´ìš”ì…ë‹ˆë‹¤.";
	    	else if(myLikeCheck == "N" && myDislikeCheck == "N") myChoice.innerHTML = username + "ë‹˜ì€ ì•„ì§ ì„ íƒì„ ì•ˆ í–ˆë„¤ìš”";
	}
	
	const disLikeView = () => {
	    
	    if(myDislikeCheck == "Y" && myLikeCheck =="N") {
	        alert("ì‹«ì–´ìš”ë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤."); 
	        const checkCnt = 4; // dislikeCnt --
	        myDislikeCheck = "N";
	        sendDataToServer(myLikeCheck,myDislikeCheck,checkCnt);
	        document.querySelector('.dislikeClick').style.backgroundColor = '#d2d2d2';
	    } else if(myDislikeCheck = "N" && myLikeCheck =="Y") {
	        alert("ì¢‹ì•„ìš”ê°€ ì·¨ì†Œë˜ê³  ì‹«ì–´ìš”ê°€ ë“±ë¡ë©ë‹ˆë‹¤.");
	        const checkCnt = 5; //likeCnt -- , dislikeCnt ++            
	        myLikeCheck = "N";            
	        myDislikeCheck = "Y";
	        sendDataToServer(myLikeCheck,myDislikeCheck,checkCnt);
	        document.querySelector('.likeClick').style.backgroundColor = '#d2d2d2';
	        document.querySelector('.dislikeClick').style.backgroundColor = '#00B9FF';
	    } else if(myDislikeCheck = "N" && myLikeCheck =="N") {
	        alert("ì‹«ì–´ìš”ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.");
	    	const checkCnt = 6; //dislikeCnt ++
	        myDislikeCheck = "Y";
	        sendDataToServer(myLikeCheck,myDislikeCheck,checkCnt);
	        document.querySelector('.dislikeClick').style.backgroundColor = '#00B9FF';
	    }
	    if(myLikeCheck == "Y") myChoice.innerHTML = username + "ë‹˜ì˜ ì„ íƒì€ ì¢‹ì•„ìš”ì…ë‹ˆë‹¤.";
	    	else if(myDislikeCheck == "Y") myChoice.innerHTML = username + "ë‹˜ì˜ ì„ íƒì€ ì‹«ì–´ìš”ì…ë‹ˆë‹¤.";
	    	else if(myLikeCheck == "N" && myDislikeCheck == "N") myChoice.innerHTML = username + "ë‹˜ì€ ì•„ì§ ì„ íƒì„ ì•ˆ í–ˆë„¤ìš”";
	}
	
	const sendDataToServer = async (myLike, myDislike, checkCount) => {
	
	    const myLikeCheck = myLike;
	    const myDislikeCheck = myDislike;
	    const checkCnt = checkCount;
	    
	    const queryString = {"seqno": parseInt('[[${view.seqno}]]'),
	    		  "userid": '[[${session.userid}]]',
	    		"mylikecheck":myLikeCheck,"mydislikecheck":myDislikeCheck,"checkCnt":checkCnt};
	
		console.log(queryString);
		await fetch('/board/likeCheck', {
			
			method: 'POST',
			headers: {
				"content-type": "application/json"
			},
			body: JSON.stringify(queryString)			
		}).then((response) => response.json())
		  .then((data)=> {			  
			  like.innerHTML = data.likeCnt;
			  dislike.innerHTML = data.dislikeCnt;
       }).catch((error)=> {
    	   console.log("error = " + error);
       });	
		
	}
// ì¢‹ì•„ìš”, ì‹«ì–´ìš” ì œì´ì¿¼ë¦¬ ì²˜ë¦¬ í•¨ìˆ˜ ë


	const deleteBoard = () => {
		if(confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
			const seqno = '[[${view.seqno}]]';
			document.location.href='/board/delete?seqno=' + seqno;
		}
	}
	
	// ëŒ“ê¸€ ì²˜ë¦¬ 
	const replyRegister = async () => {
	
	const replycontent = document.querySelector('#replycontent');
	if(replycontent.value == '') {alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."); replycontent.focus(); return false;}
	
	const data = {			
		replywriter: replywriter.value, 
		replycontent: replycontent.value,
		userid: userid.value,
		seqno: seqno.value			
	}
	
	await fetch('/board/reply?option=I', {
		method: 'POST',
		headers: {"content-type":"application/json"},
		body: JSON.stringify(data)		
	}).then((response) => response.json())
	  .then((data) => replyList(data))
	  .catch((error)=> {
		  console.log("error = " + error);
		  alert("ì‹œìŠ¤í…œ ì¥ì• ë¡œ ëŒ“ê¸€ ë“±ë¡ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	});
	
	replycontent.value = '';
	
	}

	const replyList = (data) => {
		
		var session_userid = '[[${session.userid}]]';
		const jsonInfo = data;
		
		let replyList = document.querySelector('#replyList');
		replyList.innerHTML = '';
		
		var result = "";
		for(const i in jsonInfo){
			
			let elm = document.createElement('div'); //<div></div>
			elm.setAttribute("id", "s" + data[i].replyseqno); //<div id='s3'></div>
			elm.setAttribute("style", "font-size: 0.8em"); //<div id='s3' style='font-size: 0.8em'></div>
			
			let result = "";

			result += "ì‘ì„±ì : " + jsonInfo[i].replywriter;
							
			if(jsonInfo[i].userid == session_userid) {
				result += "[<a href=" + "'javascript:replyModify(" + jsonInfo[i].replyseqno + ")' style='cursor:pointer;'>ìˆ˜ì •</a> | " ;
				result += "<a href=" + "'javascript:replyDelete(" + jsonInfo[i].replyseqno + ")' style='cursor:pointer;'>ì‚­ì œ</a>]" ;
			}
			
			result += "&nbsp;&nbsp;" + jsonInfo[i].replyregdate
			result += "<div style='width:90%; height: auto; border-top: 1px solid gray; overflow: auto;'>";
			result += "<pre id='c" + jsonInfo[i].replyseqno + "'>" + jsonInfo[i].replycontent + "</pre></div>";
			result += "<br>";
			
			elm.innerHTML = result;
			replyList.appendChild(elm);
			
		}
	}

	const startupPage = async () => {
		const data = { seqno: "[[${view.seqno}]]"};
		
		await fetch('/board/reply?option=L', {
			method: 'POST',
			headers: {"content-type":"application/json"},
			body: JSON.stringify(data)		
		}).then((response) => response.json())
		  .then((data) => replyList(data))
		  .catch((error)=> {
			  console.log("error = " + error);
			  alert("ì‹œìŠ¤í…œ ì¥ì• ë¡œ í˜ì´ì§€ ë¡œë”©ì´ ì‹¤íŒ¨.");
		});
	}

	const replyDelete = async (replyseqno) => { 
		
		if(confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?") == true) {
			const data = { replyseqno: replyseqno, seqno: "[[${view.seqno}]]"};
			await fetch('/board/reply?option=D',{
				
				method: 'POST',
				headers: {
					"content-type": "application/json"
				},
				body: JSON.stringify(data)				
			}).then((response) => response.json())
			  .then((data) => replyList(data))
			  .catch((error) => {
				  console.log("error =" + error);
				  alert("ì„œë²„ ì¥ì• ë¡œ ëŒ“ê¸€ ì‚­ì œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
		   });
		
		}
	
	}

	const replyModify = (replyseqno) => {

		const modifyReplyContent = document.querySelector('#c' + replyseqno);
		
		var strReplyList = "ì‘ì„±ì : [[${session.userid}]]&nbsp;"
						+ "<input type='button' id='btn_replyModify' value='ìˆ˜ì •'>"
						+ "<input type='button' id='btn_replyModifyCancel' value='ì·¨ì†Œ'>"
						+ "<input type='hidden' name='replyseqno' value='" + replyseqno + "'>"
						+ "<input type='hidden' name='seqno' value='[[${view.seqno}]]'>"
						+ "<input type='hidden' id='writer' name='replywriter' value='[[${session.username}]]'>"
						+ "<input type='hidden' id='uerid' name='userid' value='[[${session.userid}]]'><br>"
						+ "<textarea id='modify_replycontent' name='replycontent' cols='80' rows='5' maxlength='150' placeholder='ê¸€ììˆ˜:150ì ì´ë‚´'>" + modifyReplyContent.innerHTML + "</textarea><br>";
		
		let elm = document.createElement('div');
		elm.innerHTML = strReplyList;
		
		let parentDiv = document.querySelector('#s' + replyseqno).parentNode;
		parentDiv.insertBefore(elm, document.querySelector('#s' + replyseqno));
		document.querySelector('#s' + replyseqno).style.display = 'none';

		const btnReplyModify = document.querySelector('#btn_replyModify');
		const btnReplyModifyCancel = document.querySelector('#btn_replyModifyCancel');
		
		btnReplyModify.addEventListener('click', async ()=> {
			
			const data = {
				replyseqno: replyseqno,
				replycontent: modify_replycontent.value
			};
			
			await fetch('/board/reply?option=U',{
				
				method: 'POST',
				headers: {
					"content-type": "application/json"
				},
				body: JSON.stringify(data)
			}).catch((error) => {
				console.log("error = " + error);
				alert("ì„œë²„ ì¥ì• ë¡œ ëŒ“ê¸€ ìˆ˜ì •ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
			});
			
			document.querySelector('#replyList').innerHTML = '';
			startupPage();				
			
		});
		
		btnReplyModifyCancel.addEventListener('click',()=> {
			if(confirm("ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?") == true){
				document.querySelector('#replyList').innerHTML = '';
				startupPage();	
			}
		});
		
	}
		
	const replyCancel = () => { 
		if(confirm("ì •ë§ë¡œ ì·¨ì†Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?") == true) { 
			replycontent.value = ''; 
			replycontent.focus(); 
		}
	}

	
</script>
<style>

.likeClick, .dislikeClick {
    padding: 8px 8px;
    margin: 1px;
	text-align: center;	
	text-decoration: none;
	font-size:30px;
    border: solid 1px #a0a0a0;
    display: inline-block;
    background-color: #d2d2d2;
    border-radius: 50%
}
#like, #dislike {
	font-size: 30px
}
.likeForm {
	text-align: center;
	width: auto;
	height: auto;
	margin: auto;
}
.bottom_menu {
	margin-top: 20px;
}

.bottom_menu > a:link, .bottom_menu > a:visited {
	background-color: #FFA500;
	color: maroon;
	padding: 15px 25px;
	text-align: center;
	display: inline-block;
	text-decoration: none;
}

.bottom_menu > a:hover, .bottom_menu > a:active {
	background-color: #1E90FF;
	text-decoration: none;
}

</style>
</head>

<body>

<script>
const userid = '[[${session.userid}]]';
if(userid == '')
	document.location.href='/user/login';
	startupPage();
</script>

<div>
	<img id="topBanner" src="/images/logo.jpg" title="ì„œìš¸ê¸°ìˆ êµìœ¡ì„¼í„°">	
</div>

<div class="main">
	<h1>ê²Œì‹œë¬¼ ë‚´ìš© ë³´ê¸°</h1>
	<br>
	<div class="boardView">
		<div class="field">ì´ë¦„ : <span th:text="${view.writer}"></span></div>
		<div class="field">ì œëª© : <span th:text="${view.title}"></span></div>
		<div class="field">ë‚ ì§œ : <span th:text="${view.regdate}"></span></div>
		<div class="content"><pre th:text="${view.content}"></pre></div>
		<div class="likeForm">
			<span id="like"></span>&nbsp;<a href="javascript:likeView()" id="likeClick" class="likeClick">ğŸ˜€</a>
			<a href="javascript:disLikeView()" id="disLikeClick" class="dislikeClick">ğŸ˜¡</a>&nbsp;<span id="dislike"></span><br>
			<span id="myChoice" style="text-align:center; color:red"></span>
		</div>
		<br>
		
		<th:block th:if="${fileListView != null}">
			<th:block th:each="fileView : ${fileListView}">
				<div class="field">íŒŒì¼ëª… : <a th:href="@{/board/filedownload(fileseqno=${fileView.fileseqno})}" th:text="${fileView.org_filename}"></a> ( <span th:text="${fileView.filesize}"></span> Byte )</div>
			</th:block>
		</th:block>
		<th:block th:if="${#lists.isEmpty(fileListView)}">

			<div class="field">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
		</th:block>
	</div>

	<br>
	<div class="bottom_menu">
		<th:block th:if="${pre_seqno != 0}">
			&nbsp;&nbsp;<a th:href="@{'/board/view?seqno=' + ${pre_seqno} + '&page=' + ${page} + '&keyword=' + ${keyword}}">ì´ì „ê¸€â–¼</a>&nbsp;&nbsp;
		</th:block>
		<a th:href="@{'/board/list?page=' + ${page} + '&keyword=' + ${keyword}}">ëª©ë¡ë³´ê¸°</a>&nbsp;&nbsp;
		<th:block th:if="${next_seqno != 0}">
			<a th:href="@{'/board/view?seqno=' + ${next_seqno} + '&page=' + ${page} + '&keyword=' + ${keyword}}">ë‹¤ìŒê¸€â–²</a>&nbsp;&nbsp;
		</th:block>
		<a href="/board/write">ê¸€ ì‘ì„±</a>&nbsp;&nbsp;
		<th:block th:if="${session.userid == view.userid}">
			<a th:href="@{'/board/modify?seqno=' + ${view.seqno} + '&page=' + ${page} + '&keyword=' + ${keyword}}">ê¸€ ìˆ˜ì •</a>&nbsp;&nbsp;
			<a href="javascript:deleteBoard()">ê¸€ ì‚­ì œ</a>
		</th:block>
	</div>	
	<br>
	<div class="replyDiv" style="width:60%; height:300px; margin:auto; text-align:left;">
		<p id="replyNotice">ëŒ“ê¸€ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”</p>
		<form id="replyForm" name="replyForm" method="POST"> 
			ì‘ì„±ì : <input type="text" id="replywriter" name="replywriter" th:value="${session.username}" readonly><br>
			<textarea id="replycontent" name="replycontent" cols="80" rows="5" maxlength="150" placeholder="ê¸€ììˆ˜:150ì ì´ë‚´"></textarea><br>
			<input type="hidden" id="seqno" name="seqno" th:value="${view.seqno}">
			<input type="hidden" id="userid" name="userid" th:value="${session.userid}">
		</form>
		<input type="button" id="btn_reply" value="ëŒ“ê¸€ë“±ë¡" onclick="replyRegister()">
		<input type="button" id="btn_cancel" value="ì·¨ì†Œ" onclick="replyCancel()">
		<hr>
		
		<div id="replyList" style="width:100%; height:600px; overflow:auto;"></div>		
	</div>

	
</div>
<br><br>
</body>
</html>